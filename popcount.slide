PopCountãŒGo1.7ã‹ã‚‰ã‚ã¾ã‚Šã«æ—©ããªã£ãŸã®ã§èª¿ã¹ã¦ã¿ãŸ
æ¨ªæµœGoèª­æ›¸ä¼š #12
9 Dec 2017

Tooru Takahashi

@tooru

https://github.com/tooru/gopl-popcount


* è©±ã™ã“ã¨

- çµŒç·¯
- SSAå½¢å¼ã¨ã¯
- PopCountæœ€é©åŒ–ã‚’è¿½ã†
- ã¾ã¨ã‚

* çµŒç·¯

- æ›¸ç±ã€Œãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èªGoã€ã®ç·´ç¿’å•é¡Œ11.6ã§[[https://github.com/tooru/gopl-popcount/blob/master/src/main/main.go#L16][popCount]]é–¢æ•°ã®é€Ÿåº¦ã‚’è©•ä¾¡ã™ã‚‹ã¨ã„ã†å•é¡ŒãŒã‚ã‚‹ã€‚popCountã¨ã¯int64ã®ãƒ“ãƒƒãƒˆåˆ—ã«1ãŒã„ãã¤ã‚ã‚‹ã‹æ•°ãˆã‚‹é–¢æ•°ã€‚
- å‰å›ã®èª­æ›¸ä¼šã§ã€æœ€è¿‘ã®Goã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã¯è³¢ããªã£ãŸãŸã‚PopCountãŒé€Ÿããªã‚Šå•é¡Œã¨ã—ã¦æˆç«‹ã—ãªããªã£ãŸã¨è©±é¡Œã«
- ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯çµæœ (PopCountå‘¼å‡ºã—ã‚’ãƒ«ãƒ¼ãƒ—ã™ã‚‹ã ã‘)
 go version go1.6.4 linux/amd64
 $ go test -bench .
 BenchmarkPopCount          200000000            6.89 ns/op
 
 go version go1.7.0 linux/amd64
 $ go test -bench .
 BenchmarkPopCount          2000000000           0.42 ns/op // ç©ºé–¢æ•°å‘¼ã³å‡ºã—ã¨åŒã˜ãã‚‰ã„æ—©ã„ãã†ãª
 
 go version go1.9.2 linux/amd64
 $ go test -bench .
 BenchmarkPopCount          2000000000           0.44 ns/op // æœ€æ–°ã§ã‚‚åŒã˜ãã‚‰ã„


- ç¢ºã‹ã«ç„¡èŒ¶è‹¦èŒ¶æ—©ã„ã€‚Go1.7ã‹ã‚‰SSAå½¢å¼ãŒå°å…¥ã•ã‚ŒãŸã‹ã‚‰ã¨è¨€ã£ã¦ãŸã‚ˆã†ãªğŸ¤”


* SSAå½¢å¼ã¨ã¯(1/2) æ¦‚è¦

- SSAå½¢å¼ (Static Single Assignment Form) ã¨ã¯ã€ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©å†…éƒ¨ã§æ‰±ã†ã®ä¸­é–“è¡¨ç¾(IR)ã®1ã¤ã€‚SSAå½¢å¼ã‚’ç”¨ã„ã‚‹ã¨ã‚³ãƒ¼ãƒ‰æœ€é©åŒ–ãŒã‚„ã‚Šã‚„ã™ã„ã€‚
- é›‘ãªã‚³ãƒ³ãƒ‘ã‚¤ãƒ©å‹•ä½œèª¬æ˜ï¼šã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰â†’æŠ½è±¡æ§‹æ–‡æœ¨(AST)â†’ã‚¢ã‚»ãƒ³ãƒ–ãƒªè¨€èª
- ASTã‚„ã‚¢ã‚»ãƒ³ãƒ–ãƒªè¨€èªã‚’ãã®ã¾ã¾ã§æœ€é©åŒ–ã™ã‚‹ã®ã¯å¤§å¤‰ã€‚ASTã§ã¯è¤‡é›‘ã€‚æ©Ÿæ¢°èªã¯ASTã‚ˆã‚Šæƒ…å ±ãŒè½ã¡ã¦ã„ã‚‹ã€‚
- ãã®é–“ã«SSAå½¢å¼ã‚’å…¥ã‚Œã‚Œã°æœ€é©åŒ–ã®å¹…ãŒåºƒãŒã‚‹ã€‚
- æ¡ç”¨ã—ã¦ã„ã‚‹ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ï¼šLLVMã€JavaVM(JIT Compiler)ã€WebKitã€Swiftãªã©ã€‚æ—¥æœ¬ã§ã¯COINSãŒçŸ¥ã‚‰ã‚Œã¦ã„ã‚‹ã€‚
.image slide/compiler.png

* SSAå½¢å¼ã¨ã¯(2/2) ä¸è¦ã‚³ãƒ¼ãƒ‰å‰Šé™¤ã®ä¾‹

- [[https://ja.wikipedia.org/wiki/%E9%9D%99%E7%9A%84%E5%8D%98%E4%B8%80%E4%BB%A3%E5%85%A5][Wikipedia SSAå½¢å¼]]ã®ä¾‹ã‚ˆã‚Šã€‚

 1: y := 1 # yã¯2è¡Œç›®ã§2ãŒä»£å…¥ã•ã‚Œã‚‹ã®ã§1ã®ä»£å…¥ã¯ä¸è¦
 2: y := 2
 3: x := y

- 1è¡Œç›®ãŒä¸è¦ãªã®ã¯äººé–“ã«ã¯åˆ†ã‹ã‚‹ãŒã€ãã®ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã‚’æ›¸ãã®ã¯é›£ã—ã„ã€‚ãƒ‡ãƒ¼ã‚¿ã®æµã‚Œã‚’è¿½ã†å¿…è¦ãŒã‚ã‚‹ğŸ‘¨â€ğŸ’»
- ã“ã‚Œã‚’SSAå½¢å¼ã«ã™ã‚‹ã€‚å¤‰æ•°ã¸ã®ä»£å…¥æ–‡ã¯1å›ã®ã¿ã€‚å†ä»£å…¥ã¯æ–°ã—ã„å¤‰æ•°ãƒ˜ã®ä»£å…¥ã¨ã™ã‚‹ã€‚

 1: y1 := 1 # y1ã¯ã©ã“ã‹ã‚‰ã‚‚ä½¿ã‚ã‚Œãªã„ã®ã§ä¸è¦
 2: y2 := 2 # y2ã‚’æ„è­˜ã—ãªãã¦ã‚‚y1ãŒä¸è¦ã¨ã‚ã‹ã‚‹
 3: x1 := y2
- SSAå½¢å¼ã«ã—ãŸã“ã¨ã§ã€ã©ã“ã‹ã‚‰ã‚‚åˆ©ç”¨ã•ã‚Œã¦ã„ãªã„å¤‰æ•°ã‚’æ¢ã™ã ã‘ã§ã€y1ã®ä»£å…¥ãŒä¸è¦ã‚³ãƒ¼ãƒ‰ã¨ã‚ã‹ã‚‹ã€‚ä¸Šã‚ˆã‚Šã‚‚å˜ç´”ãªã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã§å®Ÿç¾å¯èƒ½ğŸ¤–

: ç„¡é™ã«ãƒ¬ã‚¸ã‚¹ã‚¿ãŒã‚ã‚‹ã‚¢ã‚»ãƒ³ãƒ–ãƒªè¨€èªãªæ„Ÿã˜

* PopCountã®æœ€é©åŒ–ã‚’è¿½ã†

PopCountãŒã©ã†æœ€é©åŒ–ã•ã‚Œã¦ã„ãã‹è¦‹ã¦ã„ã

 $ env GOSSAFUNC=PopCount go tool compile popcount.go
 $ open ssa.html # ssaå½¢å¼ãŒæœ€é©åŒ–ã•ã‚Œã¦ã„ãéç¨‹ã‚’è¦‹ã‚‰ã‚Œã‚‹

.link https://htmlpreview.github.io/?https://github.com/tooru/gopl-popcount/blob/master/slide/ssa_popcount.html ssa.html (PopCount)

- æœ€åˆã®SSAå½¢å¼ã‹ã‚‰ã®å¤‰åŒ–ã‚’è¦‹ã‚‹ã¨ãƒ»ãƒ»ãƒ»

- xã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒéƒ½åº¦ãƒ¡ãƒ¢ãƒªçµŒç”±ã®ã‚¢ã‚¯ã‚»ã‚¹æœ€åˆã«å¤‰æ•°(ãƒ¬ã‚¸ã‚¹ã‚¿)ã«å…¥ã‚Œã¦æ¬¡ã‹ã‚‰ãã‚Œã‚’å†åˆ©ç”¨ (after generic cseã€v16ãªã©)
- ãƒ¡ãƒ¢ãƒªã‚¢ã‚¯ã‚»ã‚¹ã‚’å…¨ã¦çµ‚ãˆã¦ã‹ã‚‰æ•°å€¤æ¼”ç®— (after lowerã€CPU archã”ã¨ã«å¤‰æ›ã€å¤§ããé †åºãŒå…¥ã‚Œæ›¿ã‚ã‚‹)

- æ—©ããªã‚Šãã†ãªæ°—ã‚‚ã™ã‚‹ãŒã€ã“ã‚Œã§æœ¬å½“ã«æ—©ããªã‚‹ã®ã‹ï¼Ÿ

* ã“ã‚Œã§æœ¬å½“ã«æ—©ããªã‚‹ã®ã‹ï¼Ÿ

- Goã®ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã«ã¯SSAå½¢å¼ã®å„æœ€é©åŒ–ãƒ•ã‚§ãƒ¼ã‚ºã®ON/OFFã‚’èª¿æ•´ã™ã‚‹ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒã‚ã‚‹

 $ go compile -d 'ssa/generic_cse/off' PopCount.go
 $ go build -gcflags='-d=ssa/generic_cse/off' PopCount.go # ã“ã‚Œã§ã‚‚åŒã˜

- ãŸã ã—ã€ã„ãã¤ã‹ã®æœ€é©åŒ–ãƒ•ã‚§ãƒ¼ã‚ºã¯OFFã«ã§ããªã„
[[https://github.com/golang/go/blob/release-branch.go1.9/src/cmd/compile/internal/ssa/compile.go][è©³ç´°ã¯cmd/compile/internal/ssa/compile.goå‚ç…§]] (require:trueã¯offã«ã§ããªã„)

- offã«ã§ãã‚‹ã‚„ã¤ã‚’ç‰‡ã£ç«¯ã‹ã‚‰offã£ã¦è¨ˆæ¸¬

 $ go test -gcflags='-d=ssa/early_phielim/off,ssa/early_copyelim,ssa/early_deadcode/off,\
 ssa/short_circuit/off,ssa/generic_cse/off,ssa/phiopt/off,ssa/nilcheckelim/off,ssa/prove/off,\
 ssa/loopbce/off,ssa/generic_deadcode/off,ssa/check_bce/off,ssa/fuse/off,ssa/dse/off,\
 ssa/insert_resched_checks/off,ssa/tighten/off,ssa/lowered_cse/off,ssa/late_phielim/off,\
 ssa/late_copyelim/off,ssa/phi_tighten/off,ssa/late_deadcode/off,ssa/likelyadjust/off,\
 ssa/late_nilcheck/off,ssa/loop_rotate/off,ssa/trim/off' -bench .
 BenchmarkPopCount-4                    2000000000               0.81 ns/op

- æœ€é©åŒ–ON (0.4ns)ã‚ˆã‚Šã¯é…ããªã£ãŸãŒã€Go1.6.4 (6.89ns)ã»ã©é…ããªã„ğŸ¤”

* è¨ˆæ¸¬æ–¹æ³•å¤‰æ›´

- ã©ã†ã‚‚ã‚¢ã‚»ãƒ³ãƒ–ãƒªè¨€èªã‚’è¦‹ãªãŒã‚‰èª¿ã¹ã¦ã„ãå¿…è¦ãŒã‚ã‚Šãã†
- go test -bench ã ã¨testãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒé–“ã«å…¥ã‚‹ã®ã§è¿½ã„ã¥ã‚‰ãã†
- mainé–¢æ•°ã ã‘ã«æãç›´ã—ã¦è¨ˆæ¸¬

.code -numbers src/main/main.go /^const n =/,/^}/

 $ go run main.go
 0.41ns

- go test -benchã¨åŒã˜ãã‚‰ã„ã®é€Ÿåº¦ã«ãªã£ãŸã€‚ã“ã‚Œãƒ™ãƒ¼ã‚¹ã«èª¿ã¹ã¦ã„ãã€‚

* ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã—ã¦ã‚¢ã‚»ãƒ³ãƒ–ãƒªè¨€èªã‚’è¦—ã (1/2)

 $ go tool compile -S main.go > main.s

PopCountã¯ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã¨åŒã˜ã‚ˆã†ã«æœ€é©åŒ–ã•ã‚Œã¦ã„ã‚‹

.code -numbers slide/main.s /\(main.go:25\) +MOVQ/,/^ +0x001d/
.code -numbers slide/main.s /^ +0x0076/,/^ +0x008e/

* ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã—ã¦ã‚¢ã‚»ãƒ³ãƒ–ãƒªè¨€èªã‚’è¦—ã (2/2)

- ã¤ã„ã§ã«mainã‚‚è¦‹ã¦ãŠãã¨

.code -numbers slide/main.s /^ +0x0021.*CALL/,/^ +0x0053.*CALL/

ã‚“ï¼Ÿãƒ«ãƒ¼ãƒ—ã®ä¸­èº«ãŒç©ºã£ã½ã€‚ã€‚ğŸ˜¨

* ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯é–¢æ•°ã«ã‚‚ã©ã‚‹

.code src/popcount_test.go /^func BenchmarkPopCount/,/^}/

 $ env GOSSAFUNC=BenchmarkPopCount go test -gcflags=-S -bench .

.code slide/popcount_test.popcount.s

- ã“ã¡ã‚‰ã‚‚ç©ºãƒ«ãƒ¼ãƒ—ã«ç½®ãæ›ã‚ã£ã¦ã„ã‚‹ã€‚ãã®ç†ç”±ã¯[[https://htmlpreview.github.io/?https://github.com/tooru/gopl-popcount/blob/master/slide/ssa_popcount_test.html][ssa.html]] ã‚’è¦‹ã‚‹ã¨åˆ†ã‹ã‚‹ã€‚


* ä½•ãŒèµ·ãã¦ã„ãŸã®ã‹

- PopCountå‘¼ã³å‡ºã—ãŒãƒ«ãƒ¼ãƒ—å†…ã«ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³å±•é–‹ã•ã‚ŒSSAæœ€é©åŒ–ãƒ•ã‚§ãƒ¼ã‚ºã§ä¸è¦ã‚³ãƒ¼ãƒ‰ã¨åˆ¤æ–­ã•ã‚Œã¦æ¶ˆãˆã‚‹ğŸ™ƒ 
- æœ€é©åŒ–å¾Œã®BenchmarkPopCountã®ã‚¤ãƒ¡ãƒ¼ã‚¸
 func BenchmarkPopCount(b *testing.B) {
     for i := 0; i < b.N; i++ {
         //popCount(0x1234567890ABCDEF) // æœ€é©åŒ–ã«ã‚ˆã‚Šæ¶ˆæ»…
     }
 }
- ã¤ã¾ã‚Špopcount_testã¯Go1.7ä»¥é™æ­£ã—ãè¨ˆæ¸¬ã§ãã¦ã„ãªã„ğŸ˜±
- ç©ºé–¢æ•°å‘¼ã³å‡ºã—ã¨åŒã˜é€Ÿåº¦ã«ãªã‚‹ã‚ã‘ã§ã‚ã‚‹
- æ­£ã—ãæ¸¬å®šã™ã‚‹ãŸã‚ã«ã¯å·¥å¤«ãŒå¿…è¦ã€‚



* å†æ¸¬å®šæ¡ˆ (1/2) ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³å±•é–‹Off

- ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³åŒ–ã‚’æŠ‘åˆ¶ã€‚-gcflags='-l' ã‚’ã¤ã‘ã‚Œã°ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³å±•é–‹ã•ã‚Œãªã„ã€‚
- é–¢æ•°å‘¼ã³å‡ºã—ã«ã‚ˆã‚‹ã‚ªãƒ¼ãƒãƒ˜ãƒƒãƒ‰ãŒå¤§ãã„ã€‚

 $ go test -gcflags='-l' -bench . 
 BenchmarkPopCount              200000000                8.58 ns/op (Go1.6.4)â˜…
 BenchmarkPopCount              200000000                6.71 ns/op (Go1.7)
 BenchmarkPopCount              200000000                5.81 ns/op (Go1.9.2)

- å†æ² (æœ€åˆã®è¨ˆæ¸¬çµæœ)

 BenchmarkPopCount              200000000                6.89 ns/op (Go1.6.4)â˜…
 BenchmarkPopCount              2000000000               0.42 ns/op (Go1.7)  
 BenchmarkPopCount              2000000000               0.44 ns/op (Go1.9.2)

- æ¡ä»¶ã«ã‚ˆã£ã¦ã¯ä½¿ã„é“ãŒã‚ã‚‹ã‹ã‚‚ã—ã‚Œãªã„
- ãªãŠã€Go1.6ã§ã‚‚ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³å±•é–‹ã¯ã—ã¦ã„ãŸãŸã‚é…ããªã£ã¦ã„ã‚‹(â˜…)ã€‚

* å†æ¸¬å®šæ¡ˆ (2/2) dead code ã¨è¦‹ãªã•ã‚Œãªã„ã‚ˆã†ã«ã™ã‚‹ã€‚

- æˆ»ã‚Šå€¤ã‚’ä½¿ã£ã¦ã„ãªã„ã¨ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã«ä¸è¦ã¨åˆ¤æ–­ã•ã‚Œã¦ã—ã¾ã†ã®ã§æœ€å¾Œã«ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«ä»£å…¥ã™ã‚‹ã€‚ä½œç‚ºçš„ãªä»£å…¥ã«ã‚ˆã‚Šå¤šå°‘æ€§èƒ½ã«å½±éŸ¿ã™ã‚‹ãŒã€ã‚„ã‚€ãªã—ã‹ã€‚

.code src/popcount_test.go /^var benchResult int/,/^}$/
 BenchmarkPopCount2              200000000                7.20 ns/op (Go1.6.4)
 BenchmarkPopCount2              300000000                3.99 ns/op (Go1.7)
 BenchmarkPopCount2              1000000000               2.03 ns/op (Go1.9.2)

- ã‚ˆã†ã‚„ãæ¯”ã¹ã‚‰ã‚Œã‚‹ã‚ˆã†ã«ãªã£ãŸ
- Go1.7ãŠã‚ˆã³Go1.9.2ã§ä½•ãŒæœ€é©åŒ–ã•ã‚ŒãŸã‹ã¯ã€Appendix1,2å‚ç…§


* ğŸ’¡è£œè¶³ (11.6ã‚’è§£ããŸã‚ã«)

- ç·´ç¿’å•é¡Œ11.6ã¯PopCountã®é…åˆ—åˆæœŸåŒ–ã‚’å«ã‚ãŸæ™‚é–“ãŒè©¦è¡Œå›æ•°ã‚’å¢—ã‚„ã™ã“ã¨ã§ã€åŠ¹ç‡ã®æ‚ªã„ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ (ã‚·ãƒ•ãƒˆã‚„ãƒ“ãƒƒãƒˆåè»¢ç‰ˆ)ã‚’ã„ã¤é ƒã‹ã‚‰è¿½ã„æŠœãã‹ã‚’èª¿ã¹ã‚‹ã¨ã„ã†ã‚‚ã®ã€‚
- ä»Šå›å˜ç´”ãªãƒ«ãƒ¼ãƒ—ã‚’è¨ˆæ¸¬ã—ãŸãŒã€å®Ÿéš›ã«ã¯ä»¥ä¸‹ã®é–¢æ•°ã¨åŠ¹ç‡ã®æ‚ªã„ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã‚’è¨ˆæ¸¬ã—æ¯”è¼ƒã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚

.code -numbers src/popcount_test.go /^func benchmarkPopCount\(/,/^}/

- ã“ã®ã‚³ãƒ¼ãƒ‰ã‚‚PopCounté–¢æ•°å‘¼ã³å‡ºã—ã¯æœ€é©åŒ–ã§æ¶ˆå»ã•ã‚Œã‚‹ãŸã‚å·¥å¤«ãŒå¿…è¦
- å‰æ®µã®é…åˆ—pcåˆæœŸåŒ–ãƒ«ãƒ¼ãƒ—ã¯æœ€é©åŒ–ã§æ¶ˆãˆãªã‹ã£ãŸ (Go1.9.2)


* ã¾ã¨ã‚

âœ…ï¸âƒ£ Benchmarkã¯ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã®æœ€é©åŒ–å‡¦ç†ã«ã‚ˆã£ã¦æ­£ã—ãè¨ˆæ¸¬ã§ããªã„å ´åˆãŒã‚ã‚‹ã€‚

- ä»Šå›ã®ã‚ˆã†ã«dead codeã¨åˆ¤æ–­ã•ã‚Œã‚‹ã“ã¨ãŒã‚ã‚‹ã€‚
- æ¥µç«¯ã«é€Ÿããªã£ãŸã‚‰ã‚¢ã‚»ãƒ³ãƒ–ãƒªè¨€èªã‚’ç¢ºèªã™ã‚‹ã€‚

âœ…âƒ£ ç·´ç¿’å•é¡Œ11.6ã¯ã€ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã®æ°—æŒã¡ã«ãªã£ã¦æœ€é©åŒ–ã‚’é¿ã‘ã¤ã¤ã€æ¡ä»¶ã‚’è¨­å®šã—ã¦è§£ãå¿…è¦ãŒã‚ã‚‹ã€‚ãªã‹ãªã‹ã®é›£å•ã§ã‚ã‚‹ã€‚


* ä»–ã‚„ã£ã¦ã„ã¦æ°—ã¥ã„ãŸç‚¹

1ï¸âƒ£ Goã®ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ãŒGoã§æ›¸ã‹ã‚Œã¦ã„ã‚‹

-  ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©è‡ªèº«ãŒGoã§æ›¸ã‹ã‚Œã¦ã„ã‚‹ã®ã§ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã®ã‚³ãƒ¼ãƒ‰ã‚‚èª­ã‚ãªãã¯ãªã„ã€‚ã“ã‚Œãªã‚‰èª­ã‚“ã§ã¿ã‚ˆã†ã‹ãªã¨ã„ã†æ°—ã«ã¯ãªã‚‹ã€‚(æ‰±ã†å†…å®¹ãŒãã‚‚ãã‚‚é›£ã—ã„ãŒ)

2ï¸âƒ£ BitCounté–¢æ•°ã¯æ¥µé™ã¾ã§æœ€é©åŒ–ã•ã‚Œã¦ã„ã‚‹

- BitCounté–¢æ•° (Hacker's Delightç‰ˆ)ã‚‚åŒæ§˜ã«é–¢æ•°å‘¼ã³å‡ºã—ãŒæ¶ˆæ»…ã—ã¦ã„ãŸãŸã‚æˆ»ã‚Šå€¤ã‚’å¤‰æ•°ã«ä»£å…¥ã—ã¦å†è¨ˆæ¸¬ã—ãŸã€‚
- ãã‚Œã§ã‚‚ã‚ã¾ã‚Šã«æ—©ã„ (ç©ºé–¢æ•°å‘¼ã³å‡ºã—ä¸¦) ã®ã§ã‚¢ã‚»ãƒ³ãƒ–ãƒªã‚³ãƒ¼ãƒ‰ã‚’ç¢ºèªã—ãŸã¨ã“ã‚æœ€é©åŒ–ã«ã‚ˆã‚Šã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚ã«æˆ»ã‚Šå€¤(ç­”ãˆ)ãŒè¨ˆç®—ã•ã‚Œã¦ã„ãŸã€‚
- ãƒ«ãƒ¼ãƒ—ã§æ¯å›ãƒ¬ã‚¸ã‚¹ã‚¿ã«å³å€¤32(0x1234567890ABCDEFã®ãƒ“ãƒƒãƒˆãŒ1ã®æ•°)ã‚’ä»£å…¥ã™ã‚‹ã‚³ãƒ¼ãƒ‰ãŒç”Ÿæˆã•ã‚Œã¦ã„ã‚‹ã€‚ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©æã‚‹ã¹ã—ã€‚
- è©³ç´°ã¯Appendix3å‚ç…§

* å‚è€ƒæ–‡çŒ®

- [[https://golang.org/doc/go1.7#compiler][Go 1.7 Release Notes #Compiler Toolchain]]
- [[https://en.wikipedia.org/wiki/Static_single_assignment_form][Static single assignment form - Wikipedia]]
- [[https://shinpei.github.io/blog/2016/08/13/what-ssa-brings-to-go-17][Go1.7ã‹ã‚‰SSAãŒå°å…¥ã•ã‚ŒãŸ - flyhigh]]
- [[https://docs.google.com/document/d/1szwabPJJc4J-igUZU4ZKprOrNRNJug2JPD8OYi3i1K0][New SSA Backend for the Go Compiler]]

* Appendix1. Go1.7ã® BenchmarkPopCount2 ã®ã‚¢ã‚»ãƒ³ãƒ–ãƒªã‚³ãƒ¼ãƒ‰

.code -numbers slide/BenchmarkPopCount2-1.7.s /^    0x0005/,/^    0x0048/

- (1)pcã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’8å›å–å¾—ã™ã‚‹ã®ã§ã¯ãªãã€ä¸€æ—¦ãƒ¬ã‚¸ã‚¹ã‚¿(CX)ã«æ ¼ç´ã—å†åˆ©ç”¨
- (2)ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³å±•é–‹ã«ã‚ˆã£ã¦å¼•ãæ•°(0x1234567890ABCDEF)ã®å„ãƒã‚¤ãƒˆã‚’ãƒ“ãƒƒãƒˆã‚·ãƒ•ãƒˆã—ãŸå€¤ãŒã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚ã«è¨ˆç®—ã•ã‚Œã¦ã„ã‚‹ã€‚
- å‚è€ƒ:  [[https://htmlpreview.github.io/?https://github.com/tooru/gopl-popcount/blob/master/slide/ssa_benchpopcount2_1.7.html][ssa.html]]

* Appendix2. Go1.9.2ã® BenchmarkPopCount2 ã®ã‚¢ã‚»ãƒ³ãƒ–ãƒªã‚³ãƒ¼ãƒ‰

.code -numbers slide/BenchmarkPopCount2-1.9.2.s /^    0x0005/,/^    0x004c/

- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä¸€æ—¦ãƒ¬ã‚¸ã‚¹ã‚¿ã«å…¥ã‚Œã‚‹ã“ã¨ãªãã€MOVBLZX 1å‘½ä»¤ã«ã€‚
- å‚è€ƒ:  [[https://htmlpreview.github.io/?https://github.com/tooru/gopl-popcount/blob/master/slide/ssa_benchpopcount2_1.9.2.html][ssa.html]]

: MOVBLZX MOV Byte to Long?(word) with Zero Extension ãƒ¡ãƒ¢ãƒªã®ãƒã‚¤ãƒˆã‚’ãƒ¯ãƒ¼ãƒ‰ã‚µã‚¤ã‚ºã®ãƒ¬ã‚¸ã‚¹ã‚¿ã«0æ‹¡å¼µã—ã¦æ ¼ç´ã€ã ã¨æ€ã†

* Appendix3. Go1.9.2ã® BenchmarkBitCount2 æœ€é©åŒ– (1/2)

.code -numbers src/popcount.go /^func bitCount/,/^}/

.code -numbers slide/BenchmarkBitCount2-1.9.2.s /^    0x000a/,/^    0x0020/

- ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³å±•é–‹ã«ã‚ˆã£ã¦ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚ã«ç­”ãˆãŒè¨ˆç®—ã•ã‚Œã¦ã„ã‚‹ã€‚ãƒ«ãƒ¼ãƒ—ã§æ¯å›ãƒ¬ã‚¸ã‚¹ã‚¿ã«å³å€¤32ã‚’ä»£å…¥ã—ã¦ã„ã‚‹ã ã‘ã€‚
- å‚è€ƒ:  [[https://htmlpreview.github.io/?https://github.com/tooru/gopl-popcount/blob/master/slide/ssa_benchbitcount2_1.9.2.html][ssa.html]] ã€Œafter optã€ã§ç­”ãˆãŒè¨ˆç®—ã•ã‚Œã¦ã„ã‚‹ã€‚

* Appendix3. Go1.9.2ã® BenchmarkBitCount2 æœ€é©åŒ– (2/2)

- bitCountæœ€é©åŒ–å¾Œã®ã‚¤ãƒ¡ãƒ¼ã‚¸

 var benchResult int
 
 func BenchmarkBitCount2(b *testing.B) {
     var c int
     for i := 0; i < b.N; i++ {
         c = 32 //bitCount(0x1234567890ABCDEF)
     }
     benchResult = c
 }

* èª­æ›¸ä¼š#12ã§ã®è³ªå•

â“ç©ºãƒ«ãƒ¼ãƒ—ã¯ãªãœæœ€é©åŒ–ã§æ¶ˆãˆãªã„ã®ã‹

- ã§ãã‚‹ã®ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒã€ç©ºãƒ«ãƒ¼ãƒ—ã§ã‚ã‚‹ã“ã¨ã®åˆ¤åˆ¥ãŒé›£ã—ã„æ°—ãŒã—ã¾ã™ã€‚
- [[https://github.com/tooru/gopl-popcount/blob/master/src/main/main.go#L74][src/main/main.go]]ã®mainé–¢æ•°ã®[[https://htmlpreview.github.io/?https://github.com/tooru/gopl-popcount/blob/master/slide/ssa_main_1.9.2.html][ssa.html]]ã®ã€Œafter trimã€ã‚’å‚ç…§ (å³ã‹ã‚‰2ç•ªç›®)ã€‚ç©ºãƒ«ãƒ¼ãƒ—ã¨ã¯ã„ãˆçµæ§‹è¤‡é›‘ã§ã™ã€‚

 b1:
  ...
  v66 = MOVQconst <int> [0] : BX           ; i = 0
 Plain â†’ b2                                ; goto b2

 b4: â† b2                                  ; b4ã«ã¯b2ã‹ã‚‰é£›ã‚“ã§ãã‚‹
  v80 = ADDQconst <int> [1] v8 : BX        ; i++
 Plain â†’ b2                                ; goto b2
 
 b2: â† b1 b4                               ; b2ã«ã¯b1ã‹b4ã‹ã‚‰é£›ã‚“ã§ãã‚‹
  v8 = Phi <int> v66 v80 : BX           ; v8ã«ã¯v66/v80ã©ã¡ã‚‰ã‹ãŒå…¥ã‚‹ (v66ã¨v80ã¯åŒã˜ãƒ¬ã‚¸ã‚¹ã‚¿ã‚’ä½¿ã†ã¨ã„ã†åˆ¶ç´„)
  v116 = CMPQconst <flags> [2000000000] v8 ; i < 2000000000
 LT v116 â†’ b4 b8 (likely)                  ; i < 2000000000 then goto b4 else b8

- ç©ºãƒ«ãƒ¼ãƒ—ã¨åˆ¤å®šã™ã‚‹æ±ç”¨ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã‚’æ›¸ãã®ã¯é›£ã—ã„ã®ã§ã¯(äºˆæƒ³ã§ã™)ã€‚
